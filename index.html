<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Philco IPTV Turbo</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* --- ESTILO VISUAL (MANTIDO O ESCURO/VERDE) --- */
        * { box-sizing: border-box; outline: none; user-select: none; }
        body {
            background-color: #0d0d0d; color: #ecf0f1;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0; height: 100vh; overflow: hidden; display: flex; flex-direction: column;
        }

        /* LOGIN */
        #loginScreen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
            z-index: 999; display: flex; justify-content: center; align-items: center;
        }
        .login-box {
            background: rgba(20, 20, 20, 0.95); padding: 40px; border-radius: 15px;
            border: 1px solid #333; width: 450px; text-align: center;
            box-shadow: 0 0 50px rgba(0,255,100,0.1);
        }
        .login-box h2 { color: #2ecc71; margin-bottom: 20px; font-size: 26px; }
        
        .login-box input {
            width: 100%; padding: 15px; margin: 10px 0;
            background: #222; border: 1px solid #444; color: white;
            font-size: 18px; text-align: center; border-radius: 8px;
        }
        .login-box button {
            width: 100%; padding: 15px; margin-top: 20px;
            background: #2ecc71; color: white; border: none; font-size: 20px; font-weight: bold;
            cursor: pointer; border-radius: 8px;
        }
        .login-box button:disabled { background: #555; cursor: not-allowed; }

        /* STATUS DE CARREGAMENTO */
        #loadingBar {
            width: 100%; height: 4px; background: #333; margin-top: 20px;
            border-radius: 2px; overflow: hidden; display: none;
        }
        #loadingFill {
            width: 0%; height: 100%; background: #2ecc71;
            transition: width 0.3s;
        }

        /* APP */
        #app { display: none; height: 100%; width: 100%; display: flex; }
        
        .sidebar {
            width: 320px; background: #111; display: flex; flex-direction: column;
            border-right: 1px solid #222;
        }
        .sidebar-header {
            padding: 15px; background: #151515; border-bottom: 3px solid #2ecc71;
            font-weight: bold; font-size: 18px; display: flex; justify-content: space-between;
        }
        #backBtn {
            background: #c0392b; padding: 12px; text-align: center; font-weight: bold;
            cursor: pointer; display: none; font-size: 14px;
        }
        #channelList { flex: 1; overflow-y: auto; }
        
        .list-item {
            padding: 12px 15px; border-bottom: 1px solid #222; color: #aaa;
            cursor: pointer; display: flex; justify-content: space-between; font-size: 15px;
        }
        .list-item.active { background: #2ecc71; color: #fff; font-weight: bold; }

        .main-stage {
            flex: 1; background: #000; position: relative;
            display: flex; flex-direction: column;
        }
        video { width: 100%; height: 100%; }

        .info-bar {
            position: absolute; bottom: 0; width: 100%;
            background: rgba(0,0,0,0.9); padding: 15px;
            border-top: 2px solid #2ecc71;
        }
        .program-info h1 { margin: 0; font-size: 24px; color: white; }
    </style>
</head>
<body>

    <div id="loginScreen">
        <div class="login-box">
            <h2><i class="fas fa-bolt"></i> IPTV TURBO</h2>
            <input type="text" id="host" placeholder="http://servidor:porta">
            <input type="text" id="user" placeholder="Usuário">
            <input type="password" id="pass" placeholder="Senha">
            
            <button onclick="iniciarLogin()" id="btnConnect">ENTRAR RÁPIDO</button>
            
            <div id="loadingBar"><div id="loadingFill"></div></div>
            <div id="statusMsg" style="margin-top:15px; color:#aaa; font-size:14px; min-height: 20px;"></div>
        </div>
    </div>

    <div id="app">
        <div class="sidebar">
            <div class="sidebar-header">
                <span id="listTitle">CATEGORIAS</span>
            </div>
            <div id="backBtn" onclick="renderCategories()"> VOLTAR</div>
            <div id="channelList"></div>
        </div>
        <div class="main-stage">
            <video id="videoPlayer" controls autoplay></video>
            <div class="info-bar">
                <div class="program-info">
                    <h1 id="currentChannelName">Selecione um canal</h1>
                    <p id="currentGroup" style="color:#aaa">...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuração
        const TIMEOUT_MS = 15000; // 15 segundos limite
        
        // Estado
        let categories = {};
        let hls = null;
        let selectedIndex = 0;

        window.onload = () => {
            if(localStorage.getItem('host')) {
                document.getElementById('host').value = localStorage.getItem('host');
                document.getElementById('user').value = localStorage.getItem('user');
                document.getElementById('pass').value = localStorage.getItem('pass');
            }
        };

        function atualizarStatus(msg, cor = "#aaa", progresso = 0) {
            const el = document.getElementById('statusMsg');
            el.innerText = msg;
            el.style.color = cor;
            
            const bar = document.getElementById('loadingBar');
            const fill = document.getElementById('loadingFill');
            
            if(progresso > 0) {
                bar.style.display = 'block';
                fill.style.width = progresso + '%';
            } else {
                bar.style.display = 'none';
            }
        }

        async function iniciarLogin() {
            const host = document.getElementById('host').value.trim();
            const user = document.getElementById('user').value.trim();
            const pass = document.getElementById('pass').value.trim();
            const btn = document.getElementById('btnConnect');

            if(!host || !user || !pass) {
                atualizarStatus("Preencha todos os campos!", "#ff5555");
                return;
            }

            // Tratamento da URL (Garante http:// e remove barra final)
            let cleanHost = host.startsWith('http') ? host : 'http://' + host;
            if(cleanHost.endsWith('/')) cleanHost = cleanHost.slice(0, -1);

            localStorage.setItem('host', host);
            localStorage.setItem('user', user);
            localStorage.setItem('pass', pass);

            btn.disabled = true;
            btn.style.opacity = "0.5";
            
            // Monta URL da lista
            const playlistUrl = `${cleanHost}/get.php?username=${user}&password=${pass}&type=m3u_plus&output=m3u8`;

            try {
                // TENTATIVA 1: Proxy Rápido (CorsProxy)
                atualizarStatus("Tentando servidor rápido...", "#ffff00", 30);
                await baixarLista('https://corsproxy.io/?' + encodeURIComponent(playlistUrl));

            } catch (erro1) {
                console.warn("Falha no método 1, tentando método 2...");
                
                try {
                    // TENTATIVA 2: Proxy Reserva (AllOrigins) - Mais lento mas compatível
                    atualizarStatus("Servidor rápido ocupado. Tentando rota alternativa...", "#ffaa00", 60);
                    await baixarLista('https://api.allorigins.win/raw?url=' + encodeURIComponent(playlistUrl));
                    
                } catch (erro2) {
                    console.error(erro2);
                    atualizarStatus("Falha na conexão. Verifique se digitou a PORTA correta (ex: :80 ou :8080) na url.", "#ff5555", 0);
                    btn.disabled = false;
                    btn.style.opacity = "1";
                }
            }
        }

        function baixarLista(proxyUrl) {
            return new Promise((resolve, reject) => {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), TIMEOUT_MS);

                fetch(proxyUrl, { signal: controller.signal })
                    .then(res => {
                        clearTimeout(timeoutId);
                        if (!res.ok) throw new Error("Erro " + res.status);
                        return res.text();
                    })
                    .then(data => {
                        if (data.includes("#EXTM3U")) {
                            atualizarStatus("Lista baixada! Organizando canais...", "#2ecc71", 90);
                            // Pequeno delay para a UI atualizar
                            setTimeout(() => {
                                processarLista(data);
                                iniciarApp();
                                resolve();
                            }, 100);
                        } else {
                            reject(new Error("Login inválido ou lista vazia"));
                        }
                    })
                    .catch(err => {
                        clearTimeout(timeoutId);
                        reject(err);
                    });
            });
        }

        function processarLista(data) {
            const lines = data.split('\n');
            categories = {};
            let currentGroup = "Outros";

            // Loop otimizado
            for (let i = 0; i < lines.length; i++) {
                let line = lines[i].trim();
                if (line.startsWith('#EXTINF')) {
                    const groupMatch = line.match(/group-title="([^"]*)"/);
                    if (groupMatch) currentGroup = groupMatch[1];
                    
                    const nameParts = line.split(',');
                    const name = nameParts[nameParts.length - 1];
                    
                    // Pega a próxima linha (URL)
                    if (lines[i+1] && lines[i+1].startsWith('http')) {
                        const url = lines[i+1].trim();
                        if (!categories[currentGroup]) categories[currentGroup] = [];
                        categories[currentGroup].push({ name, url, group: currentGroup });
                        i++; // Pula a linha da URL
                    }
                }
            }
        }

        function iniciarApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('app').style.display = 'flex';
            renderCategories();
        }

        function renderCategories() {
            const listDiv = document.getElementById('channelList');
            listDiv.innerHTML = "";
            document.getElementById('listTitle').innerText = "CATEGORIAS";
            document.getElementById('backBtn').style.display = 'none';

            Object.keys(categories).sort().forEach((cat, index) => {
                const div = document.createElement('div');
                div.className = 'list-item';
                div.innerHTML = `<span>${cat}</span> <small>${categories[cat].length}</small>`;
                div.onclick = () => abrirCategoria(cat);
                if(index === 0) div.classList.add('active');
                listDiv.appendChild(div);
            });
            selectedIndex = 0;
        }

        function abrirCategoria(cat) {
            const listDiv = document.getElementById('channelList');
            listDiv.innerHTML = "";
            document.getElementById('listTitle').innerText = cat;
            document.getElementById('backBtn').style.display = 'block';

            categories[cat].forEach((ch, index) => {
                const div = document.createElement('div');
                div.className = 'list-item';
                div.innerText = ch.name;
                div.onclick = () => tocarCanal(ch);
                if(index === 0) div.classList.add('active');
                listDiv.appendChild(div);
            });
            selectedIndex = 0;
        }

        function tocarCanal(ch) {
            const video = document.getElementById('videoPlayer');
            document.getElementById('currentChannelName').innerText = ch.name;
            document.getElementById('currentGroup').innerText = ch.group;

            if (Hls.isSupported()) {
                if(hls) hls.destroy();
                hls = new Hls();
                hls.loadSource(ch.url);
                hls.attachMedia(video);
                hls.on(Hls.Events.MANIFEST_PARSED, () => video.play());
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                video.src = ch.url;
                video.play();
            }
        }

        // Navegação Teclado
        document.addEventListener('keydown', (e) => {
            const items = document.querySelectorAll('.list-item');
            if(!items.length) return;
            
            items[selectedIndex].classList.remove('active');
            
            if(e.key === 'ArrowDown') selectedIndex = (selectedIndex + 1) % items.length;
            if(e.key === 'ArrowUp') selectedIndex = (selectedIndex - 1 + items.length) % items.length;
            if(e.key === 'Enter') items[selectedIndex].click();
            if(e.key === 'Backspace' || e.key === 'Escape') renderCategories();

            items[selectedIndex].classList.add('active');
            items[selectedIndex].scrollIntoView({block: 'center'});
        });
    </script>
</body>
</html>
